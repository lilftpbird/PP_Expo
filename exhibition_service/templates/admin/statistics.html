{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title }}{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .statistics-container {
        padding: 20px;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
    }
    
    .chart-title i {
        margin-right: 10px;
        color: #007cba;
    }
    
    .top-lists {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
    }
    
    .top-list {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .list-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }
    
    .list-item:last-child {
        border-bottom: none;
    }
    
    .item-info {
        display: flex;
        align-items: center;
    }
    
    .item-rank {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #007cba;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        font-size: 0.9rem;
    }
    
    .item-name {
        font-weight: 600;
        color: #333;
    }
    
    .item-count {
        background: #f8f9fa;
        padding: 5px 12px;
        border-radius: 15px;
        font-weight: 500;
        color: #007cba;
    }
    
    .period-selector {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .period-buttons {
        display: flex;
        gap: 10px;
    }
    
    .period-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .period-btn.active {
        background: #007cba;
        color: white;
        border-color: #007cba;
    }
    
    .period-btn:hover {
        background: #f8f9fa;
    }
    
    .period-btn.active:hover {
        background: #005a8b;
    }
    
    .export-buttons {
        margin-top: 20px;
        text-align: right;
    }
    
    .btn-export {
        background: #27ae60;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        text-decoration: none;
        margin-left: 10px;
        transition: background 0.3s;
    }
    
    .btn-export:hover {
        background: #219a52;
        color: white;
        text-decoration: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="statistics-container">
    <h1><i class="fas fa-chart-bar"></i> Статистика</h1>
    
    <!-- Селектор периода -->
    <div class="period-selector">
        <h3>Период анализа</h3>
        <div class="period-buttons">
            <button class="period-btn active" data-period="30">30 дней</button>
            <button class="period-btn" data-period="90">3 месяца</button>
            <button class="period-btn" data-period="180">6 месяцев</button>
            <button class="period-btn" data-period="365">1 год</button>
        </div>
    </div>
    
    <!-- Графики -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3 class="chart-title">
                <i class="fas fa-users"></i>
                Регистрация пользователей
            </h3>
            <canvas id="usersChart"></canvas>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">
                <i class="fas fa-calendar"></i>
                Создание выставок
            </h3>
            <canvas id="exhibitionsChart"></canvas>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">
                <i class="fas fa-user-check"></i>
                Регистрации на выставки
            </h3>
            <canvas id="registrationsChart"></canvas>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">
                <i class="fas fa-chart-pie"></i>
                Типы выставок
            </h3>
            <canvas id="exhibitionTypesChart"></canvas>
        </div>
    </div>
    <!-- Топ списки -->
    <div class="top-lists">
        <div class="top-list">
            <h3 class="chart-title">
                <i class="fas fa-trophy"></i>
                Топ категории
            </h3>
            {% for category in top_categories %}
            <div class="list-item">
                <div class="item-info">
                    <div class="item-rank">{{ forloop.counter }}</div>
                    <div class="item-name">{{ category.name }}</div>
                </div>
                <div class="item-count">{{ category.exhibitions_count }}</div>
            </div>
            {% endfor %}
        </div>
        
        <div class="top-list">
            <h3 class="chart-title">
                <i class="fas fa-map-marker-alt"></i>
                Топ города
            </h3>
            {% for city in top_cities %}
            <div class="list-item">
                <div class="item-info">
                    <div class="item-rank">{{ forloop.counter }}</div>
                    <div class="item-name">{{ city.city }}</div>
                </div>
                <div class="item-count">{{ city.count }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Кнопки экспорта -->
    <div class="export-buttons">
        <a href="/admin/users-export/" class="btn-export">
            <i class="fas fa-download"></i> Экспорт пользователей
        </a>
        <a href="#" class="btn-export" onclick="exportStatistics()">
            <i class="fas fa-file-excel"></i> Экспорт статистики
        </a>
    </div>
</div>

<script>
// Данные для графиков
// const dailyUsers = {{ daily_users|safe }};
// const dailyExhibitions = {{ daily_exhibitions|safe }};
// const dailyRegistrations = {{ daily_registrations|safe }};

// График пользователей
const usersCtx = document.getElementById('usersChart').getContext('2d');
new Chart(usersCtx, {
    type: 'line',
    data: {
        labels: dailyUsers.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
            label: 'Новые пользователи',
            data: dailyUsers.map(item => item.count),
            borderColor: '#007cba',
            backgroundColor: 'rgba(0, 124, 186, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// График выставок
const exhibitionsCtx = document.getElementById('exhibitionsChart').getContext('2d');
new Chart(exhibitionsCtx, {
    type: 'bar',
    data: {
        labels: dailyExhibitions.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
            label: 'Новые выставки',
            data: dailyExhibitions.map(item => item.count),
            backgroundColor: '#27ae60',
            borderColor: '#27ae60',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// График регистраций
const registrationsCtx = document.getElementById('registrationsChart').getContext('2d');
new Chart(registrationsCtx, {
    type: 'line',
    data: {
        labels: dailyRegistrations.map(item => {
            const date = new Date(item.date);
            return date.toLocaleDateString('ru-RU', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
            label: 'Регистрации',
            data: dailyRegistrations.map(item => item.count),
            borderColor: '#f39c12',
            backgroundColor: 'rgba(243, 156, 18, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

// Круговая диаграмма типов выставок
const typesCtx = document.getElementById('exhibitionTypesChart').getContext('2d');
new Chart(typesCtx, {
    type: 'doughnut',
    data: {
        labels: ['Торговые выставки', 'Конференции', 'Семинары', 'Форумы', 'Другие'],
        datasets: [{
            data: [45, 25, 15, 10, 5],
            backgroundColor: [
                '#007cba',
                '#27ae60',
                '#f39c12',
                '#e74c3c',
                '#9b59b6'
            ],
            borderWidth: 0
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Обработчики периода
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // Здесь можно добавить загрузку данных для выбранного периода
    });
});

// Функция экспорта статистики
function exportStatistics() {
    // Здесь можно реализовать экспорт статистики
    alert('Функция экспорта будет реализована');
}
</script>
{% endblock %}