{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title }}{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .moderation-container {
        padding: 20px;
    }
    
    .moderation-tabs {
        display: flex;
        background: white;
        border-radius: 10px;
        padding: 5px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .tab-btn {
        flex: 1;
        padding: 15px 20px;
        text-align: center;
        background: transparent;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        color: #666;
    }
    
    .tab-btn.active {
        background: #007cba;
        color: white;
        box-shadow: 0 2px 10px rgba(0, 124, 186, 0.3);
    }
    
    .tab-btn:hover:not(.active) {
        background: #f8f9fa;
    }
    
    .tab-content {
        display: none;
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .tab-content.active {
        display: block;
    }
    
    .moderation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .bulk-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .moderation-list {
        display: grid;
        gap: 15px;
    }
    
    .moderation-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s;
        position: relative;
    }
    
    .moderation-item:hover {
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-color: #007cba;
    }
    
    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }
    
    .item-checkbox {
        position: absolute;
        top: 15px;
        left: 15px;
        transform: scale(1.2);
    }
    
    .item-content {
        padding-left: 30px;
        flex: 1;
    }
    
    .item-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        line-height: 1.3;
    }
    
    .item-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .meta-item i {
        color: #007cba;
    }
    
    .item-description {
        color: #555;
        line-height: 1.5;
        margin-bottom: 15px;
    }
    
    .item-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    
    .btn-approve {
        background: #27ae60;
        color: white;
    }
    
    .btn-approve:hover {
        background: #219a52;
    }
    
    .btn-reject {
        background: #e74c3c;
        color: white;
    }
    
    .btn-reject:hover {
        background: #c0392b;
    }
    
    .btn-view {
        background: #007cba;
        color: white;
    }
    
    .btn-view:hover {
        background: #005a8b;
        color: white;
        text-decoration: none;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
    }
    
    .status-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-approved {
        background: #d1edff;
        color: #004085;
    }
    
    .status-rejected {
        background: #f8d7da;
        color: #721c24;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #ddd;
        margin-bottom: 20px;
    }
    
    .empty-state h3 {
        margin-bottom: 10px;
        color: #333;
    }
    
    .bulk-selector {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .select-all {
        transform: scale(1.2);
    }
    
    .selected-count {
        font-weight: 500;
        color: #007cba;
    }
    
    .review-content {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
        border-left: 4px solid #007cba;
    }
    
    .review-rating {
        color: #f39c12;
        margin-bottom: 10px;
    }
    
    .review-text {
        font-style: italic;
        color: #555;
    }
    
    .priority-high {
        border-left: 4px solid #e74c3c !important;
    }
    
    .priority-medium {
        border-left: 4px solid #f39c12 !important;
    }
    
    .priority-low {
        border-left: 4px solid #27ae60 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="moderation-container">
    <h1><i class="fas fa-gavel"></i> Модерация контента</h1>
    
    <!-- Вкладки -->
    <div class="moderation-tabs">
        <button class="tab-btn active" data-tab="exhibitions">
            <i class="fas fa-calendar"></i>
            Выставки ({{ pending_exhibitions|length }})
        </button>
        <button class="tab-btn" data-tab="companies">
            <i class="fas fa-building"></i>
            Компании ({{ pending_companies|length }})
        </button>
        <button class="tab-btn" data-tab="reviews">
            <i class="fas fa-star"></i>
            Отзывы ({{ pending_reviews|length }})
        </button>
    </div>
    
    <!-- Вкладка выставок -->
    <div class="tab-content active" id="exhibitions-tab">
        <div class="moderation-header">
            <h2><i class="fas fa-calendar"></i> Выставки на модерации</h2>
            <div class="bulk-actions">
                <button class="btn btn-approve" onclick="bulkAction('approve_exhibitions')">
                    <i class="fas fa-check"></i> Одобрить выбранные
                </button>
                <button class="btn btn-reject" onclick="bulkAction('reject_exhibitions')">
                    <i class="fas fa-times"></i> Отклонить выбранные
                </button>
            </div>
        </div>
        
        {% if pending_exhibitions %}
        <div class="bulk-selector">
            <input type="checkbox" id="select-all-exhibitions" class="select-all" onchange="selectAll('exhibitions')">
            <label for="select-all-exhibitions">Выбрать все</label>
            <span class="selected-count" id="selected-exhibitions-count">0 выбрано</span>
        </div>
        
        <div class="moderation-list">
            {% for exhibition in pending_exhibitions %}
            <div class="moderation-item priority-medium">
                <input type="checkbox" class="item-checkbox exhibition-checkbox" value="{{ exhibition.id }}" onchange="updateSelectedCount('exhibitions')">
                <div class="item-content">
                    <div class="item-header">
                        <div>
                            <h3 class="item-title">{{ exhibition.title }}</h3>
                            <div class="item-meta">
                                <div class="meta-item">
                                    <i class="fas fa-user"></i>
                                    {{ exhibition.organizer.email }}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    {{ exhibition.start_date|date:"d.m.Y" }}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    {{ exhibition.city }}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-clock"></i>
                                    {{ exhibition.created_at|timesince }} назад
                                </div>
                            </div>
                        </div>
                        <span class="status-badge status-pending">На модерации</span>
                    </div>
                    
                    <div class="item-description">
                        {{ exhibition.short_description|default:exhibition.description|truncatewords:30 }}
                    </div>
                    
                    <div class="item-actions">
                        <button class="btn btn-approve" onclick="moderateItem('exhibition', {{ exhibition.id }}, 'approve')">
                            <i class="fas fa-check"></i> Одобрить
                        </button>
                       <button class="btn btn-reject" onclick="moderateItem('exhibition', {{ exhibition.id }}, 'reject')">
                            <i class="fas fa-times"></i> Отклонить
                        </button>
                        <a href="/admin/exhibitions/exhibition/{{ exhibition.id }}/change/" class="btn btn-view">
                            <i class="fas fa-eye"></i> Просмотр
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h3>Нет выставок на модерации</h3>
            <p>Все выставки прошли модерацию</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Вкладка компаний -->
    <div class="tab-content" id="companies-tab">
        <div class="moderation-header">
            <h2><i class="fas fa-building"></i> Компании на модерации</h2>
            <div class="bulk-actions">
                <button class="btn btn-approve" onclick="bulkAction('approve_companies')">
                    <i class="fas fa-check"></i> Одобрить выбранные
                </button>
                <button class="btn btn-reject" onclick="bulkAction('reject_companies')">
                    <i class="fas fa-times"></i> Отклонить выбранные
                </button>
            </div>
        </div>
        
        {% if pending_companies %}
        <div class="bulk-selector">
            <input type="checkbox" id="select-all-companies" class="select-all" onchange="selectAll('companies')">
            <label for="select-all-companies">Выбрать все</label>
            <span class="selected-count" id="selected-companies-count">0 выбрано</span>
        </div>
        
        <div class="moderation-list">
            {% for company in pending_companies %}
            <div class="moderation-item priority-low">
                <input type="checkbox" class="item-checkbox company-checkbox" value="{{ company.id }}" onchange="updateSelectedCount('companies')">
                <div class="item-content">
                    <div class="item-header">
                        <div>
                            <h3 class="item-title">{{ company.name }}</h3>
                            <div class="item-meta">
                                <div class="meta-item">
                                    <i class="fas fa-user"></i>
                                    {{ company.created_by.email }}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-tag"></i>
                                    {{ company.category.name|default:"Без категории" }}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    {{ company.city }}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-clock"></i>
                                    {{ company.created_at|timesince }} назад
                                </div>
                            </div>
                        </div>
                        <span class="status-badge status-pending">На модерации</span>
                    </div>
                    
                    <div class="item-description">
                        {{ company.short_description|default:company.description|truncatewords:30 }}
                    </div>
                    
                    <div class="item-actions">
                        <button class="btn btn-approve" onclick="moderateItem('company', {{ company.id }}, 'approve')">
                            <i class="fas fa-check"></i> Одобрить
                        </button>
                        <button class="btn btn-reject" onclick="moderateItem('company', {{ company.id }}, 'reject')">
                            <i class="fas fa-times"></i> Отклонить
                        </button>
                        <a href="/admin/companies/company/{{ company.id }}/change/" class="btn btn-view">
                            <i class="fas fa-eye"></i> Просмотр
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h3>Нет компаний на модерации</h3>
            <p>Все компании прошли модерацию</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Вкладка отзывов -->
    <div class="tab-content" id="reviews-tab">
        <div class="moderation-header">
            <h2><i class="fas fa-star"></i> Отзывы на модерации</h2>
            <div class="bulk-actions">
                <button class="btn btn-approve" onclick="bulkAction('approve_reviews')">
                    <i class="fas fa-check"></i> Одобрить выбранные
                </button>
                <button class="btn btn-reject" onclick="bulkAction('reject_reviews')">
                    <i class="fas fa-times"></i> Отклонить выбранные
                </button>
            </div>
        </div>
        
        {% if pending_reviews %}
        <div class="bulk-selector">
            <input type="checkbox" id="select-all-reviews" class="select-all" onchange="selectAll('reviews')">
            <label for="select-all-reviews">Выбрать все</label>
            <span class="selected-count" id="selected-reviews-count">0 выбрано</span>
        </div>
        
        <div class="moderation-list">
            {% for review in pending_reviews %}
            <div class="moderation-item priority-high">
                <input type="checkbox" class="item-checkbox review-checkbox" value="{{ review.id }}" onchange="updateSelectedCount('reviews')">
                <div class="item-content">
                    <div class="item-header">
                        <div>
                            <h3 class="item-title">{{ review.title|default:"Отзыв" }}</h3>
                            <div class="item-meta">
                                <div class="meta-item">
                                    <i class="fas fa-user"></i>
                                    {{ review.user.email }}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-building"></i>
                                    {{ review.company.name }}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-clock"></i>
                                    {{ review.created_at|timesince }} назад
                                </div>
                            </div>
                        </div>
                        <span class="status-badge status-pending">На модерации</span>
                    </div>
                    
                    <div class="review-content">
                        <div class="review-rating">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    <i class="fas fa-star"></i>
                                {% else %}
                                    <i class="far fa-star"></i>
                                {% endif %}
                            {% endfor %}
                            ({{ review.rating }}/5)
                        </div>
                        <div class="review-text">
                            "{{ review.text|truncatewords:50 }}"
                        </div>
                    </div>
                    
                    <div class="item-actions">
                        <button class="btn btn-approve" onclick="moderateItem('review', {{ review.id }}, 'approve')">
                            <i class="fas fa-check"></i> Одобрить
                        </button>
                        <button class="btn btn-reject" onclick="moderateItem('review', {{ review.id }}, 'reject')">
                            <i class="fas fa-times"></i> Отклонить
                        </button>
                        <a href="/admin/companies/companyreview/{{ review.id }}/change/" class="btn btn-view">
                            <i class="fas fa-eye"></i> Просмотр
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <h3>Нет отзывов на модерации</h3>
            <p>Все отзывы прошли модерацию</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Переключение вкладок
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tabId = this.dataset.tab;
        
        // Убираем активные классы
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Добавляем активные классы
        this.classList.add('active');
        document.getElementById(tabId + '-tab').classList.add('active');
    });
});

// Выбор всех элементов
function selectAll(type) {
    const checkbox = document.getElementById(`select-all-${type}`);
    const checkboxes = document.querySelectorAll(`.${type}-checkbox`);
    
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    
    updateSelectedCount(type);
}

// Обновление счетчика выбранных
function updateSelectedCount(type) {
    const checkboxes = document.querySelectorAll(`.${type}-checkbox:checked`);
    const countElement = document.getElementById(`selected-${type}-count`);
    const count = checkboxes.length;
    
    countElement.textContent = `${count} выбрано`;
    
    // Обновляем состояние "выбрать все"
    const allCheckboxes = document.querySelectorAll(`.${type}-checkbox`);
    const selectAllCheckbox = document.getElementById(`select-all-${type}`);
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = count === allCheckboxes.length;
        selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
    }
}

// Массовые действия
function bulkAction(action) {
    let type, checkboxClass;
    
    if (action.includes('exhibitions')) {
        type = 'exhibitions';
        checkboxClass = 'exhibition-checkbox';
    } else if (action.includes('companies')) {
        type = 'companies';
        checkboxClass = 'company-checkbox';
    } else if (action.includes('reviews')) {
        type = 'reviews';
        checkboxClass = 'review-checkbox';
    }
    
    const selectedIds = Array.from(document.querySelectorAll(`.${checkboxClass}:checked`))
        .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        alert('Выберите элементы для действия');
        return;
    }
    
    const confirmation = confirm(`Подтвердите действие для ${selectedIds.length} элементов`);
    if (!confirmation) return;
    
    // Отправка AJAX запроса
    fetch('/admin/moderation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `action=${action}&ids=${selectedIds.join(',')}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка');
    });
}
</script>